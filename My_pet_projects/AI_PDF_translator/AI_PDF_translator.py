'''
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –û–∫–Ω–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–æ –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏. –°–ª–µ–≤–∞ ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF. –°–ø—Ä–∞–≤–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º.
–õ–æ–≥–∏–∫–∞: –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ PDF –±–ª–æ–∫–∞–º–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ LLM, –ø–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø—Ä–∞–≤–∞.
–ë—ç–∫–µ–Ω–¥: –†–µ–∞–ª–∏–∑—É–µ–º –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å-–æ–±–µ—Ä—Ç–∫—É –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É OpenAI, Mistral, Gemini, OpenRouter –∏ g4f.

1.–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ "–°–ª–µ–≤–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª - –°–ø—Ä–∞–≤–∞ –ø–µ—Ä–µ–≤–æ–¥":
–ü–æ—á–µ–º—É —Ç–∞–∫? –ü—ã—Ç–∞—Ç—å—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π PDF —Å —Ç–æ—á–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤–µ—Ä—Å—Ç–∫–∏, –∑–∞–º–µ–Ω—è—è –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–∏–π ‚Äî —ç—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Å–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞. –¢–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –æ–±—ã—á–Ω–æ –¥–ª–∏–Ω–Ω–µ–µ –Ω–∞ 20-30%, –æ–Ω "–ø–æ–µ–¥–µ—Ç", –Ω–∞–µ–¥–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã.
–†–µ—à–µ–Ω–∏–µ: CAT-tool –ø–æ–¥—Ö–æ–¥ (Side-by-side) –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–∏–¥–µ—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–≥—Ä–∞—Ñ–∏–∫–∏, —Å—Ö–µ–º—ã) —Å–ª–µ–≤–∞ –∏ —á–∏—Ç–∞—Ç—å —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞.
2.–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (QThread):
–í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –æ–±—â–µ–Ω–∏—è —Å API –≤—ã–Ω–µ—Å–µ–Ω –≤ –∫–ª–∞—Å—Å TranslatorWorker. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ GUI –Ω–µ –∑–∞–≤–∏—Å–Ω–µ—Ç ("–ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç"), –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä OpenAI –¥—É–º–∞–µ—Ç –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º 30 —Å–µ–∫—É–Ω–¥.
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è pyqtSignal –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ—Ç–æ–∫–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
3.–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–≤–∏–∂–æ–∫ (LLMEngine):
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 5 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, –∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏.
–î–ª—è OpenRouter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç OpenAI —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º base_url.
–î–ª—è g4f —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–±–µ—Ä—Ç–∫–∞, –Ω–æ —É—á—Ç–∏—Ç–µ, —á—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —á–∞—Å—Ç–æ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã.
–î–ª—è Mistral –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–æ–π REST API –∑–∞–ø—Ä–æ—Å.
4.–±—Ä–∞–±–æ—Ç–∫–∞ PDF:
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è pymupdf (fitz).
–î–ª—è —Ç–µ–∫—Å—Ç–∞: page.get_text("blocks") ‚Äî —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å —Ç–µ–∫—Å—Ç –∞–±–∑–∞—Ü–∞–º–∏, –∞ –Ω–µ —Ä–≤–∞–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é.
–î–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏: page.get_pixmap() ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ –¥–ª—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏.
5.–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏—á–∏:
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (self.translated_pages). –ï—Å–ª–∏ –≤—ã –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞–∑–∞–¥, –æ–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ.
–ñ–∏–≤–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä: –ï—Å–ª–∏ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 5, –∏ –ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É 5, —Ç–µ–∫—Å—Ç –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–æ–ª–µ —Å–ø—Ä–∞–≤–∞ ‚Äî —ç—Ç–æ QTextEdit. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ —Ä—É–∫–∞–º–∏, –µ—Å–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –æ—à–∏–±–ª–∞—Å—å, –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–Ω–æ –≤—ã–≥—Ä—É–∑–∏—Ç—å –≤ Markdown —Ñ–∞–π–ª, –≥–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
'''

# pip install PyQt5 pymupdf openai google-generativeai g4f requests markdown2


import sys
import os
import time
import requests
import fitz  # PyMuPDF
import markdown2

from PyQt5.QtWidgets import (QApplication, QMainWindow, QVBoxLayout, QHBoxLayout,
                             QWidget, QTextEdit, QPushButton, QLabel, QProgressBar,
                             QComboBox, QLineEdit, QSplitter, QFileDialog, QMessageBox,
                             QGroupBox, QFormLayout, QSpinBox)
from PyQt5.QtCore import QThread, pyqtSignal, Qt, QSize
from PyQt5.QtGui import QImage, QPixmap, QFont

# –ò–º–ø–æ—Ä—Ç—ã API
import openai
import google.generativeai as genai
import g4f

# ================= –õ–û–ì–ò–ö–ê LLM (–ë–≠–ö–ï–ù–î) =================

class LLMEngine:
    def __init__(self, provider, api_key, model_name):
        self.provider = provider
        self.api_key = api_key
        self.model_name = model_name

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        self.system_prompt = (
            "You are a professional technical translator. Translate the following text "
            "from English to Russian. Preserve the original formatting structure (markdown). "
            "Do not add any explanations, just the translation. "
            "Keep technical terms accurate."
        )

    def translate(self, text):
        if not text.strip():
            return ""

        try:
            if self.provider == "OpenAI":
                client = openai.OpenAI(api_key=self.api_key)
                response = client.chat.completions.create(
                    model=self.model_name,
                    messages=[
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": text}
                    ]
                )
                return response.choices[0].message.content

            elif self.provider == "Mistral":
                url = "https://api.mistral.ai/v1/chat/completions"
                headers = {"Authorization": f"Bearer {self.api_key}"}
                json_data = {
                    "model": self.model_name,
                    "messages": [{"role": "user", "content": f"{self.system_prompt}\n\nText:\n{text}"}]
                }
                response = requests.post(url, headers=headers, json=json_data)
                response.raise_for_status()
                return response.json()["choices"][0]["message"]["content"]

            elif self.provider == "Gemini":
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel(self.model_name)
                # Gemini –∏–Ω–æ–≥–¥–∞ –∫–∞–ø—Ä–∏–∑–µ–Ω –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–∞–º, –ø–æ–¥–∞–µ–º –≤ user message
                full_prompt = f"{self.system_prompt}\n\nTranslate this:\n{text}"
                response = model.generate_content(full_prompt)
                return response.text

            elif self.provider == "OpenRouter":
                # OpenRouter —Å–æ–≤–º–µ—Å—Ç–∏–º —Å OpenAI client, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–º–µ–Ω—è—Ç—å base_url
                client = openai.OpenAI(
                    base_url="https://openrouter.ai/api/v1",
                    api_key=self.api_key,
                )
                response = client.chat.completions.create(
                    model=self.model_name,
                    messages=[
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": text}
                    ]
                )
                return response.choices[0].message.content

            elif self.provider == "G4F (Free)":
                # G4F –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∫–ª—é—á–∞, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (Auto)
                response = g4f.ChatCompletion.create(
                    model=self.model_name or g4f.models.gpt_4,
                    messages=[{"role": "user", "content": f"{self.system_prompt}\n\n{text}"}],
                )
                return str(response)

        except Exception as e:
            return f"[–û–®–ò–ë–ö–ê –ü–ï–†–ï–í–û–î–ê]: {str(e)}"

        return "[–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞]"

# ================= –ü–û–¢–û–ö –ü–ï–†–ï–í–û–î–ê =================

class TranslatorWorker(QThread):
    progress_update = pyqtSignal(int, int) # —Ç–µ–∫—É—â–∞—è, –≤—Å–µ–≥–æ
    page_translated = pyqtSignal(int, str) # –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ç–µ–∫—Å—Ç
    error_occurred = pyqtSignal(str)
    finished_task = pyqtSignal()

    def __init__(self, pdf_path, engine, start_page=0):
        super().__init__()
        self.pdf_path = pdf_path
        self.engine = engine
        self.start_page = start_page
        self.is_running = True

    def run(self):
        try:
            doc = fitz.open(self.pdf_path)
            total_pages = len(doc)

            for page_num in range(self.start_page, total_pages):
                if not self.is_running:
                    break

                page = doc.load_page(page_num)
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞–º–∏, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ö–æ—Ç—å –∫–∞–∫—É—é-—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                # sort=True –ø—ã—Ç–∞–µ—Ç—Å—è —É–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏
                text_blocks = page.get_text("blocks", sort=True)

                full_page_translation = ""

                # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                raw_text = ""
                for block in text_blocks:
                    # block[4] - —ç—Ç–æ —Ç–µ–∫—Å—Ç
                    raw_text += block[4] + "\n\n"

                # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É—Å—Ç–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞—Ä—Ç–∏–Ω–∫–∞ –±–µ–∑ OCR)
                if not raw_text.strip():
                    full_page_translation = "[–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]"
                else:
                    # –ü–µ—Ä–µ–≤–æ–¥–∏–º
                    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –Ω–∞ —á–∞–Ω–∫–∏, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–≥—Ä–æ–º–Ω–∞—è,
                    # –Ω–æ –æ–±—ã—á–Ω–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞ PDF –≤–ª–µ–∑–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.
                    full_page_translation = self.engine.translate(raw_text)

                self.page_translated.emit(page_num, full_page_translation)
                self.progress_update.emit(page_num + 1, total_pages)

                # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ –¥—É–¥–æ—Å–∏—Ç—å API
                time.sleep(0.5)

            doc.close()
            self.finished_task.emit()

        except Exception as e:
            self.error_occurred.emit(str(e))

    def stop(self):
        self.is_running = False

# ================= –ì–õ–ê–í–ù–û–ï –û–ö–ù–û =================

class PDFTranslatorApp(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("AI PDF Translator Pro (PyQt5)")
        self.resize(1200, 800)

        # –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        self.pdf_doc = None
        self.pdf_path = ""
        self.translated_pages = {} # –∫—ç—à: {page_num: text}
        self.current_page = 0
        self.worker = None

        self.init_ui()

    def init_ui(self):
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        main_layout = QVBoxLayout(main_widget)

        # 1. –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settings_group = QGroupBox("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏")
        settings_layout = QHBoxLayout()

        self.combo_provider = QComboBox()
        self.combo_provider.addItems(["OpenAI", "Mistral", "Gemini", "OpenRouter", "G4F (Free)"])
        self.combo_provider.currentTextChanged.connect(self.on_provider_change)

        self.input_key = QLineEdit()
        self.input_key.setPlaceholderText("API Key")
        self.input_key.setEchoMode(QLineEdit.Password)

        self.input_model = QLineEdit()
        self.input_model.setPlaceholderText("Model (e.g. gpt-4o, gemini-pro)")
        self.input_model.setText("gpt-4o") # default

        settings_layout.addWidget(QLabel("–ü—Ä–æ–≤–∞–π–¥–µ—Ä:"))
        settings_layout.addWidget(self.combo_provider)
        settings_layout.addWidget(QLabel("–ö–ª—é—á:"))
        settings_layout.addWidget(self.input_key)
        settings_layout.addWidget(QLabel("–ú–æ–¥–µ–ª—å:"))
        settings_layout.addWidget(self.input_model)

        settings_group.setLayout(settings_layout)
        main_layout.addWidget(settings_group)

        # 2. –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–º
        file_toolbar = QHBoxLayout()

        self.btn_open = QPushButton("üìÇ –û—Ç–∫—Ä—ã—Ç—å PDF")
        self.btn_open.clicked.connect(self.open_pdf)

        self.btn_start = QPushButton("‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥")
        self.btn_start.clicked.connect(self.start_translation)
        self.btn_start.setEnabled(False)

        self.btn_stop = QPushButton("‚èπ –°—Ç–æ–ø")
        self.btn_stop.clicked.connect(self.stop_translation)
        self.btn_stop.setEnabled(False)

        self.btn_save = QPushButton("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥")
        self.btn_save.clicked.connect(self.save_translation)
        self.btn_save.setEnabled(False)

        file_toolbar.addWidget(self.btn_open)
        file_toolbar.addWidget(self.btn_start)
        file_toolbar.addWidget(self.btn_stop)
        file_toolbar.addWidget(self.btn_save)
        file_toolbar.addStretch()

        main_layout.addLayout(file_toolbar)

        # 3. –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å (Splitter)
        self.splitter = QSplitter(Qt.Horizontal)

        # –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –û—Ä–∏–≥–∏–Ω–∞–ª (–ö–∞—Ä—Ç–∏–Ω–∫–∞)
        self.left_widget = QWidget()
        l_layout = QVBoxLayout(self.left_widget)
        l_layout.addWidget(QLabel("<b>–û—Ä–∏–≥–∏–Ω–∞–ª</b>"))
        self.lbl_pdf_image = QLabel("–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF")
        self.lbl_pdf_image.setAlignment(Qt.AlignCenter)
        self.lbl_pdf_image.setStyleSheet("background-color: #eee; border: 1px solid #ccc;")
        l_layout.addWidget(self.lbl_pdf_image)

        # –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –ü–µ—Ä–µ–≤–æ–¥ (–¢–µ–∫—Å—Ç)
        self.right_widget = QWidget()
        r_layout = QVBoxLayout(self.right_widget)
        r_layout.addWidget(QLabel("<b>–ü–µ—Ä–µ–≤–æ–¥ (Markdown)</b>"))
        self.text_editor = QTextEdit()
        self.text_editor.setReadOnly(False) # –ú–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
        self.text_editor.setStyleSheet("font-size: 14px; font-family: Segoe UI;")
        r_layout.addWidget(self.text_editor)

        self.splitter.addWidget(self.left_widget)
        self.splitter.addWidget(self.right_widget)
        self.splitter.setStretchFactor(0, 1)
        self.splitter.setStretchFactor(1, 1)

        main_layout.addWidget(self.splitter, stretch=1)

        # 4. –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
        nav_layout = QHBoxLayout()
        self.btn_prev = QPushButton("<< –ü—Ä–µ–¥.")
        self.btn_prev.clicked.connect(lambda: self.change_page(-1))
        self.btn_next = QPushButton("–°–ª–µ–¥. >>")
        self.btn_next.clicked.connect(lambda: self.change_page(1))
        self.lbl_page_info = QLabel("–°—Ç—Ä: 0 / 0")

        nav_layout.addWidget(self.btn_prev)
        nav_layout.addWidget(self.lbl_page_info)
        nav_layout.addWidget(self.btn_next)

        main_layout.addLayout(nav_layout)

        # 5. –ü—Ä–æ–≥—Ä–µ—Å—Å
        self.progress_bar = QProgressBar()
        main_layout.addWidget(self.progress_bar)

        self.status_bar = QLabel("–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
        main_layout.addWidget(self.status_bar)

    # --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---

    def on_provider_change(self, text):
        # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        if text == "OpenAI":
            self.input_model.setText("gpt-4o")
            self.input_key.setEnabled(True)
        elif text == "Mistral":
            self.input_model.setText("mistral-large-latest")
            self.input_key.setEnabled(True)
        elif text == "Gemini":
            self.input_model.setText("gemini-2.5-pro")
            self.input_key.setEnabled(True)
        elif text == "OpenRouter":
            self.input_model.setText("anthropic/claude-3-opus")
            self.input_key.setEnabled(True)
        elif text == "G4F (Free)":
            self.input_model.setText("") # Auto
            self.input_key.setEnabled(False)
            self.input_key.setPlaceholderText("–ö–ª—é—á –Ω–µ –Ω—É–∂–µ–Ω")

    def open_pdf(self):
        path, _ = QFileDialog.getOpenFileName(self, "–û—Ç–∫—Ä—ã—Ç—å PDF", "", "PDF Files (*.pdf)")
        if path:
            self.pdf_path = path
            try:
                self.pdf_doc = fitz.open(path)
                self.translated_pages = {}
                self.current_page = 0
                self.update_page_view()
                self.btn_start.setEnabled(True)
                self.status_bar.setText(f"–ó–∞–≥—Ä—É–∂–µ–Ω: {os.path.basename(path)}")
                self.progress_bar.setValue(0)
            except Exception as e:
                QMessageBox.critical(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å PDF: {e}")

    def update_page_view(self):
        if not self.pdf_doc:
            return

        # 1. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–†–µ–Ω–¥–µ—Ä –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É)
        page = self.pdf_doc.load_page(self.current_page)
        pix = page.get_pixmap(matrix=fitz.Matrix(1.5, 1.5)) # Zoom –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏

        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ QImage
        img_data = pix.tobytes("ppm")
        qimg = QImage.fromData(img_data)
        pixmap = QPixmap.fromImage(qimg)

        # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ª–µ–π–±–ª–∞
        w = self.lbl_pdf_image.width()
        h = self.lbl_pdf_image.height()
        if w > 0 and h > 0:
            self.lbl_pdf_image.setPixmap(pixmap.scaled(w, h, Qt.KeepAspectRatio, Qt.SmoothTransformation))
        else:
            self.lbl_pdf_image.setPixmap(pixmap)

        # 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞
        if self.current_page in self.translated_pages:
            self.text_editor.setPlainText(self.translated_pages[self.current_page])
        else:
            self.text_editor.setPlaceholderText("–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –µ—â–µ –Ω–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞...")
            self.text_editor.clear()

        # 3. –ò–Ω—Ñ–æ
        self.lbl_page_info.setText(f"–°—Ç—Ä: {self.current_page + 1} / {len(self.pdf_doc)}")

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        self.btn_prev.setEnabled(self.current_page > 0)
        self.btn_next.setEnabled(self.current_page < len(self.pdf_doc) - 1)

    def change_page(self, delta):
        new_page = self.current_page + delta
        if 0 <= new_page < len(self.pdf_doc):
            self.current_page = new_page
            self.update_page_view()

    def resizeEvent(self, event):
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –æ–∫–Ω–∞
        self.update_page_view()
        super().resizeEvent(event)

    def start_translation(self):
        provider = self.combo_provider.currentText()
        key = self.input_key.text().strip()
        model = self.input_model.text().strip()

        if provider != "G4F (Free)" and not key:
            QMessageBox.warning(self, "–í–Ω–∏–º–∞–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ API Key!")
            return

        self.status_bar.setText("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞...")

        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        self.btn_start.setEnabled(False)
        self.btn_stop.setEnabled(True)
        self.combo_provider.setEnabled(False)

        # –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–æ–∫
        engine = LLMEngine(provider, key, model)

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
        # –ù–∞—á–∏–Ω–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π –Ω–µ–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–π, –∏–ª–∏ —Å 0? –õ—É—á—à–µ —Å 0, –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—è –≥–æ—Ç–æ–≤—ã–µ.
        # –í worker'–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–µ–º —Å 0, –∞ –≤ callback –±—É–¥–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.
        self.worker = TranslatorWorker(self.pdf_path, engine)
        self.worker.progress_update.connect(self.update_progress)
        self.worker.page_translated.connect(self.on_page_translated)
        self.worker.finished_task.connect(self.on_translation_finished)
        self.worker.error_occurred.connect(self.on_worker_error)

        self.worker.start()

    def stop_translation(self):
        if self.worker:
            self.worker.stop()
            self.status_bar.setText("–û—Å—Ç–∞–Ω–æ–≤–∫–∞...")

    def update_progress(self, current, total):
        self.progress_bar.setMaximum(total)
        self.progress_bar.setValue(current)
        self.status_bar.setText(f"–ü–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã {current} –∏–∑ {total}...")

    def on_page_translated(self, page_num, text):
        self.translated_pages[page_num] = text

        # –ï—Å–ª–∏ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
        if self.current_page == page_num:
            self.text_editor.setPlainText(text)

    def on_translation_finished(self):
        self.status_bar.setText("–ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!")
        self.btn_start.setEnabled(True)
        self.btn_stop.setEnabled(False)
        self.combo_provider.setEnabled(True)
        self.btn_save.setEnabled(True)
        QMessageBox.information(self, "–£—Å–ø–µ—Ö", "–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–µ–Ω!")

    def on_worker_error(self, err_msg):
        self.status_bar.setText("–û—à–∏–±–∫–∞!")
        self.btn_start.setEnabled(True)
        self.btn_stop.setEnabled(False)
        self.combo_provider.setEnabled(True)
        QMessageBox.critical(self, "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞", err_msg)

    def save_translation(self):
        path, _ = QFileDialog.getSaveFileName(self, "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥", "", "Markdown Files (*.md);;Text Files (*.txt)")
        if not path:
            return

        try:
            with open(path, 'w', encoding='utf-8') as f:
                for page_num in sorted(self.translated_pages.keys()):
                    f.write(f"## –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page_num + 1}\n\n")
                    f.write(self.translated_pages[page_num])
                    f.write("\n\n---\n\n")

            self.status_bar.setText(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ {path}")
        except Exception as e:
            QMessageBox.critical(self, "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", str(e))

if __name__ == "__main__":
    app = QApplication(sys.argv)

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤ –¥–ª—è HighDPI
    font = QFont("Segoe UI", 9)
    app.setFont(font)

    window = PDFTranslatorApp()
    window.show()
    sys.exit(app.exec_())